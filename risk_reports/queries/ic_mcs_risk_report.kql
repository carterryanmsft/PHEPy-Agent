// IC/MCS High-Risk Case Report with Risk Scoring
// MODIFIED: Only pulling IC (Intensive Care) customers
let ICMCSTenants = datatable(TopParentName:string, TPID:int, TenantId:string, CLE:string, PHE:string, Program:string)
[
    "Ford", 639534, "c990bb7a-51f4-439b-bd36-9c07fb1041c0", "", "Ron Mustard", "IC",
    "Sainsbury's", 7056084, "e11fd634-26b5-47f4-8b8c-908e466e9bdf", "", "Sonal Sagar", "IC",
    "Autodesk", 625338, "67bff79e-7f91-4433-a8e5-c9252d2ddc1d", "", "Tim Griffin", "IC",
    "Vodafone", 520413, "68283f3b-8487-4c86-adb3-a5228f18b893", "", "Josef Ibarra", "IC",
    "State of WA", 641135, "11d0e217-264e-400a-8ba0-57dcc127d72d", "", "Kanika Kapoor", "IC",
    "State of WA", 641135, "9ef85bca-98dd-4e6e-b55c-f296e678e989", "", "Kanika Kapoor", "IC",
    "BHP", 523272, "4f6e1565-c2c7-43cb-8a4c-0981d022ce20", "", "Manaswi Upadhyaya K", "IC",
    "AGL Energy", 1170498, "123913b9-915d-4d67-aaf9-ce327e8fc59f", "", "Maathangi Kannan Vaidehi", "IC",
    "WSP", 2831650, "3d234255-e20f-4205-88a5-9658a402999b", "", "Amulya Eedara", "IC",
    "Huntington", 645695, "157a26ef-912f-4244-abef-b45fc4bd77f9", "", "Hemanth Varyani", "IC",
    "Nestle", 604010, "12a3af23-a769-4654-847f-958f3d479f4a", "", "Josef Ibarra", "IC",
    "Santander", 1278397, "35595a02-4d6d-44ac-99e1-f9ab4cd872db", "", "Pavel Garmashov", "IC",
    "Zurich", 2656229, "95d1d810-50cf-4169-8565-6bfba279a0cd", "", "Pavel Garmashov", "IC",A
    "Novartis", 1528952, "f35a6974-607f-47d4-82d7-ff31d7dc53a5", "", "Ramana Krishnamoorthy", "IC",
    "NAB", 1104955, "48d6943f-580e-40b1-a0e1-c07fa3707873", "", "KAPIL Chopra", "IC",
    "MUFJ", 5025483, "3a498a73-f68c-4993-9940-40f5dc4b029b", "", "Salonie Vyas", "IC",
    "MUFJ", 5025483, "952d7d55-02c8-4421-ae6d-aa79da2f5152", "", "Salonie Vyas", "IC"
];
GetSCIMIncidentV2
| where ServiceRequestState != "Closed"
| where ProductName == "Microsoft Purview Compliance"
| join kind=inner ICMCSTenants on TenantId
| extend DaysOpen = todouble(CaseAge)
| where DaysOpen >= 20  // Cases 20+ days old
// Preserve original RelatedICM_Id before filtering
| extend OriginalICM_Id = RelatedICM_Id
// Filter out SCIM Escalation Management cases
// For cases with ICMs, check if any are from non-SCIM teams
| extend ICMList = split(RelatedICM_Id, ",")
| mv-expand ICMId = ICMList to typeof(long)
| join kind=leftouter (
    cluster('icmcluster').database('IcmDataWarehouse').Incidents
    | summarize arg_max(ModifiedDate, OwningTenantName) by IncidentId
    | project IncidentId, OwningTenantName
) on $left.ICMId == $right.IncidentId
// Keep cases with no ICM or with non-SCIM ICMs, exclude cases with only SCIM ICMs
| where isempty(OriginalICM_Id) or OwningTenantName != "SCIM Escalation Management" or isnull(OwningTenantName)
// Collapse back to unique cases - PRESERVE ORIGINAL ICM ID
| summarize OriginalICM_Id = any(OriginalICM_Id) by 
    ServiceRequestNumber, ServiceRequestStatus, ServiceRequestState, ProductName, 
    DerivedProductName, TenantId, TopParentName, TpAccountName, SAPPath, Program, 
    PHE, CLE, AgentAlias, ManagerEmail, ServiceRequestCurrentSeverity, CreatedTime,
    CaseAge, OwnershipCount, TransferCount, ReopenCount, IsCritSit, QueueName, 
    TPID, CaseUri, ModifiedDate
| extend RelatedICM_Id = OriginalICM_Id
| extend DaysOpen = todouble(CaseAge)
// Calculate idle period (days since last modification)
| extend DaysSinceUpdate = datetime_diff('day', now(), ModifiedDate)
// Calculate risk score (0-100) based on ICM CRI Risk Score methodology
| extend RiskScore = 
    // 1. Age/Status factor (0-40 points): exponential increase with age
    case(
        DaysOpen > 180, 40,
        DaysOpen > 120, 35,
        DaysOpen > 90, 30,
        DaysOpen > 60, 25,
        DaysOpen > 30, 20,
        10
    )
    // 2. Ownership changes (0-20 points): instability/confusion indicator
    + case(
        OwnershipCount > 20, 20,
        OwnershipCount > 10, 15,
        OwnershipCount > 5, 10,
        OwnershipCount > 2, 5,
        0
    )
    // 3. Transfer count (0-15 points): expertise gaps/organizational issues
    + case(
        TransferCount > 20, 15,
        TransferCount > 10, 12,
        TransferCount > 5, 8,
        TransferCount > 2, 4,
        0
    )
    // 4. Idle period (0-15 points): stalled resolution indicator
    + case(
        DaysSinceUpdate > 30, 15,
        DaysSinceUpdate > 21, 12,
        DaysSinceUpdate > 14, 8,
        DaysSinceUpdate > 7, 4,
        0
    )
    // 5. Reactivation/Reopen count (0-10 points): unresolved root cause
    + case(
        ReopenCount >= 3, 10,
        ReopenCount == 2, 7,
        ReopenCount == 1, 5,
        0
    )
    // 6. ICM presence (0-10 points): escalation indicator
    + case(
        isnotempty(RelatedICM_Id), 10,
        0
    )
    // 7. Severity (0-5 points): urgency multiplier
    + case(
        ServiceRequestCurrentSeverity in ("1", "A", "Critical"), 5,
        ServiceRequestCurrentSeverity in ("2", "B", "High"), 3,
        0
    )
    // Crit Sit automatic boost
    + case(
        IsCritSit == "Yes", 10,
        0
    )
| extend RiskScore = iff(RiskScore > 100, 100, RiskScore)  // Cap at 100
| extend RiskLevel = case(
    RiskScore >= 80, "Critical",
    RiskScore >= 60, "High",
    RiskScore >= 40, "Medium",
    "Low"
)
| extend AgeCategory = case(
    DaysOpen > 180, "Critical (>180 days)",
    DaysOpen > 120, "Very High (>120 days)",
    DaysOpen > 90, "High (>90 days)",
    DaysOpen > 60, "Elevated (>60 days)",
    DaysOpen > 30, "Moderate (>30 days)",
    "Recent (20-30 days)"
)
| extend HasICM = iff(isnotempty(RelatedICM_Id), "Yes", "No")
// Generate summary description
| extend Summary = strcat(
    "Case is ", tostring(toint(DaysOpen)), " days old, ",
    "status is ", ServiceRequestStatus, ", ",
    "ICM present: ", HasICM, ". ",
    case(
        OwnershipCount > 10, strcat("Extremely high ownership (", OwnershipCount, ") and transfer (", TransferCount, ") counts indicate severe instability."),
        OwnershipCount > 5, strcat("High ownership (", OwnershipCount, ") and transfer (", TransferCount, ") counts increase risk."),
        OwnershipCount > 2, strcat("Ownership (", OwnershipCount, ") and transfer (", TransferCount, ") counts add to risk."),
        "No major additional risk factors."
    )
)
| project 
    ModifiedDate,
    ServiceRequestNumber,
    CaseUrl = CaseUri,  // Rename CaseUri to CaseUrl for consistency
    ServiceRequestStatus,
    ServiceRequestState,
    ProductName,
    DerivedProductName,
    TenantId,
    TopParentName,  // Customer name
    TpAccountName,
    SAPPath,
    Program,  // MCS or IC
    PHE,  // Product Health Engineer
    CLE,  // Customer Lead Engineer
    AgentAlias,  // Case Owner
    ManagerEmail,  // Case Owner Manager
    ServiceRequestCurrentSeverity,
    CreatedTime,
    DaysOpen,
    AgeCategory,
    OwnershipCount,
    TransferCount,
    ReopenCount,
    RelatedICM_Id,
    HasICM,
    IsCritSit,
    RiskScore,
    RiskLevel,
    Summary,
    QueueName,
    TPID
| order by RiskScore desc, DaysOpen desc

// Optional: Summary by risk level and program
// | summarize CaseCount = count(), 
//             AvgDaysOpen = avg(DaysOpen),
//             AvgRiskScore = avg(RiskScore)
//             by RiskLevel, Program
// | order by RiskLevel asc, Program asc
